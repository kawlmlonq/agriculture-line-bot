# 測試端點使用說明

## 🎯 概述

專案提供 `/test` 端點供開發測試使用，但**生產環境強烈建議停用**。

---

## 🔒 三種安全模式

### 模式 1：完全停用（生產環境推薦）⭐

**設定：**
```bash
# .env
ENABLE_TEST_ENDPOINT=False
```

**效果：**
- 端點返回 404（攻擊者以為不存在）
- 最安全的方式

**測試命令：**
```bash
curl -X POST http://localhost:5000/test -H "Content-Type: application/json" -d '{"question":"test"}'
# 返回 404 Not Found
```

---

### 模式 2：啟用但需要 API Key 驗證（生產環境可選）

**設定：**
```bash
# .env
ENABLE_TEST_ENDPOINT=True
TEST_API_KEY=your-strong-random-key-here-min-32-chars
```

**生成強密碼：**
```powershell
# PowerShell
[Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
```

**測試命令：**
```bash
# 有效的 API Key
curl -X POST http://localhost:5000/test \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-strong-random-key-here" \
  -d '{"question":"水稻種植季節？"}'

# 無效的 API Key
curl -X POST http://localhost:5000/test \
  -H "Content-Type: application/json" \
  -H "X-API-Key: wrong-key" \
  -d '{"question":"test"}'
# 返回 401 Unauthorized
```

---

### 模式 3：開發模式（僅本地開發）

**設定：**
```bash
# .env
ENABLE_TEST_ENDPOINT=True
# TEST_API_KEY 使用預設值（不安全，僅開發）
```

**測試命令：**
```bash
curl -X POST http://localhost:5000/test \
  -H "Content-Type: application/json" \
  -d '{"question":"水稻種植季節？"}'
```

⚠️ **警告：** 此模式無認證保護，僅供本地開發使用！

---

## 🧪 測試範例

### PowerShell 測試腳本

```powershell
# 測試無認證
$body = @{
    question = "水稻的種植季節是什麼時候？"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:5000/test" `
    -Method POST `
    -ContentType "application/json" `
    -Body $body

# 測試有認證
$headers = @{
    "X-API-Key" = "your-api-key-here"
}

Invoke-RestMethod -Uri "http://localhost:5000/test" `
    -Method POST `
    -Headers $headers `
    -ContentType "application/json" `
    -Body $body
```

### Python 測試腳本

```python
import requests

# 無認證
response = requests.post(
    'http://localhost:5000/test',
    json={'question': '水稻的種植季節是什麼時候？'}
)
print(response.json())

# 有認證
response = requests.post(
    'http://localhost:5000/test',
    headers={'X-API-Key': 'your-api-key-here'},
    json={'question': '水稻的種植季節是什麼時候？'}
)
print(response.json())
```

---

## 📊 環境建議配置

### 本地開發
```bash
DEBUG=True
ENABLE_TEST_ENDPOINT=True
# TEST_API_KEY 可省略（使用預設值）
```

### 測試/預生產環境
```bash
DEBUG=False
ENABLE_TEST_ENDPOINT=True
TEST_API_KEY=test-env-strong-key-32-chars-min
```

### 生產環境
```bash
DEBUG=False
ENABLE_TEST_ENDPOINT=False
# TEST_API_KEY 不需要（端點已停用）
```

---

## 🚨 安全注意事項

### ✅ 安全做法

1. **生產環境停用**
   ```bash
   ENABLE_TEST_ENDPOINT=False
   ```

2. **使用強密碼**
   - 至少 32 字元
   - 使用隨機生成器
   - 不要使用預測值

3. **定期輪替**
   - 每 90 天更換 TEST_API_KEY
   - 懷疑洩漏時立即更換

4. **監控使用**
   ```python
   # 查看日誌中的警告
   # "⚠️  未授權的測試端點存取嘗試"
   ```

### ❌ 避免的做法

1. ❌ 生產環境使用預設 API Key
2. ❌ 在公開文件中寫死 API Key
3. ❌ 使用簡單密碼（如 "test123"）
4. ❌ 在前端 JavaScript 中暴露 API Key

---

## 🔄 替代測試方案

如果不需要 HTTP 端點測試，建議使用：

### 方案 1：直接 Python 測試（推薦）

```python
# test_local.py
from src.qa_engine import QAEngine
from src.vector_store import VectorStore

vector_store = VectorStore()
qa_engine = QAEngine(vector_store)

# 直接測試
result = qa_engine.answer_question("水稻種植季節？")
print(f"問題：{result['answer']}")
print(f"來源：{result['sources']}")
```

**優點：**
- 不需要啟動 Flask
- 不會暴露 HTTP 端點
- 更快、更安全

### 方案 2：使用 LINE Bot 測試

在開發環境：
1. 啟動 Flask + ngrok
2. 直接在 LINE 上測試
3. 查看 Flask 日誌

**優點：**
- 測試完整流程
- 真實使用場景
- 無需額外端點

### 方案 3：單元測試

```python
# tests/test_qa_engine.py
import pytest
from src.qa_engine import QAEngine
from src.vector_store import VectorStore

def test_answer_question():
    vector_store = VectorStore()
    qa_engine = QAEngine(vector_store)
    
    result = qa_engine.answer_question("水稻種植")
    assert result['answer']
    assert len(result['sources']) > 0
```

**優點：**
- 自動化測試
- CI/CD 整合
- 不需要運行伺服器

---

## 📝 檢查清單

部署前確認：

- [ ] 生產環境 `ENABLE_TEST_ENDPOINT=False`
- [ ] 如需啟用，已設定強 `TEST_API_KEY`
- [ ] TEST_API_KEY 不等於預設值
- [ ] API Key 已加入 `.gitignore`（在 `.env` 中）
- [ ] 執行 `.\安全檢查.ps1` 通過
- [ ] 日誌監控已設定（檢查未授權存取）

---

## 🔗 相關文件

- [SECURITY.md](./SECURITY.md) - 完整安全指南
- [安全檢查.ps1](./安全檢查.ps1) - 自動安全檢查
- [README.md](./README.md) - 專案說明

---

**建議：** 生產環境完全停用測試端點，使用 LINE Bot 或 Python 直接測試作為替代方案。
