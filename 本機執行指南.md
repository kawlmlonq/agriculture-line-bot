# 本機電腦執行指南 🖥️

本指南將協助您在 Windows 本機電腦上執行農業 LINE Bot，並透過 ngrok 提供外部連線。

---

## 📋 目錄

1. [優勢說明](#優勢說明)
2. [環境需求](#環境需求)
3. [快速啟動（5 分鐘）](#快速啟動)
4. [外部連線設定](#外部連線設定)
5. [開機自動啟動](#開機自動啟動)
6. [日常使用](#日常使用)
7. [故障排除](#故障排除)

---

## 🎯 優勢說明

### 為什麼選擇本機執行？

✅ **完全免費** - 無需付費雲端服務
✅ **效能最佳** - 直接使用本機硬體資源
✅ **即時更新** - 修改程式碼立即生效
✅ **完整控制** - 可隨時查看日誌和狀態
✅ **開發友善** - 方便除錯和測試

### 資源需求

- **RAM**: 約 200-400MB（輕量）
- **CPU**: 閒置時幾乎不佔用，回答問題時短暫使用
- **磁碟**: 約 500MB（含向量資料庫）
- **網路**: 僅在有訊息時才使用，流量極低

---

## 💻 環境需求

### 必要條件

1. **Windows 10/11** - 64 位元
2. **Python 3.13** - 已安裝（您已有 ✓）
3. **網路連線** - 穩定的網路環境
4. **ngrok 帳號** - 免費帳號即可

### 檢查清單

```powershell
# 1. 檢查 Python 版本
python --version
# 應顯示: Python 3.13.x

# 2. 檢查虛擬環境
.\.venv\Scripts\Activate.ps1
python -c "import flask, groq, chromadb; print('環境正常')"

# 3. 檢查向量資料庫
python -c "from src.vector_store import VectorStore; vs = VectorStore(); print(f'文件數: {vs.collection.count()}')"
# 應顯示: 文件數: 234
```

---

## 🚀 快速啟動

### 方法一：使用啟動腳本（推薦）

1. **雙擊執行** `快速啟動.bat`

這會自動：
- ✅ 啟動虛擬環境
- ✅ 檢查環境變數
- ✅ 啟動 Flask 伺服器（Port 5000）
- ✅ 顯示系統狀態

2. **確認啟動成功**

看到以下訊息表示成功：
```
✅ 向量資料庫已載入，包含 234 個文件塊
 * Running on http://127.0.0.1:5000
```

### 方法二：手動啟動

```powershell
# 1. 進入專案目錄
cd C:\agriculture-line-bot

# 2. 啟動虛擬環境
.\.venv\Scripts\Activate.ps1

# 3. 啟動應用
python app.py
```

### 驗證運行狀態

開啟瀏覽器，前往：
- **Health Check**: http://localhost:5000/health
- **測試端點**: http://localhost:5000/test

---

## 🌐 外部連線設定

### ngrok 設定（推薦）

#### 步驟 1：註冊 ngrok

1. 前往 https://dashboard.ngrok.com/signup
2. 註冊免費帳號（可用 Google/GitHub）
3. 取得您的 Authtoken

#### 步驟 2：安裝 ngrok

下載方式：
- **方式 A（推薦）**: 使用 Chocolatey
  ```powershell
  choco install ngrok
  ```

- **方式 B**: 手動下載
  1. 下載：https://ngrok.com/download
  2. 解壓到 `C:\ngrok\`
  3. 加入到 PATH 環境變數

#### 步驟 3：設定 Authtoken

```powershell
# 設定您的 authtoken（從 ngrok dashboard 取得）
ngrok config add-authtoken YOUR_AUTHTOKEN_HERE
```

#### 步驟 4：啟動 ngrok

**選項 A：使用啟動腳本**
```powershell
.\啟動ngrok.bat
```

**選項 B：手動啟動**
```powershell
ngrok http 5000
```

#### 步驟 5：取得公開網址

ngrok 啟動後會顯示：
```
Forwarding   https://xxxx-xx-xx-xxx-xxx.ngrok-free.app -> http://localhost:5000
```

複製 `https://xxxx-xx-xx-xxx-xxx.ngrok-free.app` 這個網址

---

## 🔗 LINE Bot Webhook 設定

### 更新 LINE Developers Console

1. **前往** LINE Developers Console
   - https://developers.line.biz/console/

2. **選擇您的 Provider 和 Channel**

3. **Messaging API 設定**
   - 找到 "Webhook URL"
   - 輸入：`https://your-ngrok-url.ngrok-free.app/callback`
   - 點擊 "Verify" 驗證
   - 點擊 "Update" 儲存

4. **啟用 Webhook**
   - 開啟 "Use webhook" 開關

5. **關閉自動回覆**
   - 到 "Messaging API" 標籤
   - 關閉 "Auto-reply messages"
   - 關閉 "Greeting messages"（選用）

### 驗證設定

發送訊息給您的 LINE Bot，應該會收到回覆！

---

## 🔄 開機自動啟動（選用）

### 方法一：工作排程器

1. **開啟工作排程器**
   - Win + R → `taskschd.msc`

2. **建立基本工作**
   - 名稱：`Agriculture LINE Bot`
   - 觸發程序：登入時
   - 動作：啟動程式
   - 程式：`C:\agriculture-line-bot\快速啟動.bat`
   - 起始於：`C:\agriculture-line-bot`

3. **進階設定**
   - ✅ 以最高權限執行
   - ✅ 設定為：Windows 10
   - ✅ 允許工作視需要執行

### 方法二：啟動資料夾

1. **建立捷徑**
   - 右鍵 `快速啟動.bat` → 建立捷徑

2. **移動到啟動資料夾**
   - Win + R → `shell:startup`
   - 將捷徑移到此資料夾

### ngrok 自動啟動

**建立 ngrok 啟動服務**：

1. 編輯 `啟動ngrok.bat`：
```batch
@echo off
title Agriculture Bot - ngrok Tunnel
echo 🌐 正在啟動 ngrok tunnel...
echo.

REM 如果 ngrok 在 PATH 中
ngrok http 5000 --log=stdout

REM 如果手動安裝在 C:\ngrok\
REM C:\ngrok\ngrok.exe http 5000 --log=stdout

pause
```

2. 同樣加入工作排程器或啟動資料夾

---

## 📱 日常使用

### 每日啟動流程

1. **啟動應用程式**
   ```powershell
   雙擊 快速啟動.bat
   ```

2. **啟動 ngrok**
   ```powershell
   雙擊 啟動ngrok.bat
   ```

3. **複製 ngrok 網址** → **更新 LINE Webhook**

### 保持運行

- **不要關閉** PowerShell 視窗
- **最小化**視窗即可
- 電腦可以正常使用其他程式

### 查看狀態

```powershell
# 檢查系統狀態
.\檢查狀態.bat

# 或手動查看
curl http://localhost:5000/health
```

### 停止服務

- 在 PowerShell 視窗按 `Ctrl + C`
- 或直接關閉視窗

---

## 🔧 故障排除

### 問題 1：Port 5000 被佔用

**錯誤訊息**：
```
OSError: [WinError 10048] 通常一個通訊端位址只允許使用一次
```

**解決方法**：
```powershell
# 查看佔用 Port 5000 的程式
netstat -ano | findstr :5000

# 結束該程式（替換 PID）
taskkill /PID <PID> /F

# 或修改 .env 使用其他 Port
PORT=5001
```

### 問題 2：ngrok 網址經常變動

**免費方案限制**：每次重啟 ngrok，網址會改變

**解決方案**：

**選項 A：升級 ngrok（推薦）**
- ngrok Pro: $8/月，固定網址
- https://ngrok.com/pricing

**選項 B：使用其他服務**
- **Cloudflare Tunnel**（免費，固定網址）
- **LocalTunnel**（免費）
- **Serveo**（免費）

**選項 C：接受變動**
- 每天早上重啟時更新 LINE Webhook
- 寫腳本自動更新（需要 LINE API）

### 問題 3：電腦休眠後無法連線

**原因**：電腦休眠會中斷網路連線

**解決方法**：

1. **關閉休眠**（不建議筆電）
   - 設定 → 電源與睡眠 → 永不休眠

2. **使用排程喚醒**
   - 工作排程器設定定時喚醒

3. **接受限制**
   - 僅在使用電腦時提供服務
   - 或考慮使用桌機而非筆電

### 問題 4：虛擬環境啟動失敗

**錯誤訊息**：
```
無法載入檔案，因為這個系統上已停用指令碼執行
```

**解決方法**：
```powershell
# 以管理員身分執行 PowerShell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 重新啟動
.\.venv\Scripts\Activate.ps1
```

### 問題 5：LINE Bot 無回應

**檢查清單**：

1. **本機服務運行中？**
   ```powershell
   curl http://localhost:5000/health
   ```

2. **ngrok 運行中？**
   - 檢查 ngrok 視窗是否開啟
   - 訪問 ngrok 提供的網址

3. **Webhook 設定正確？**
   - LINE Console → Webhook URL 是否最新
   - 點擊 "Verify" 是否成功

4. **防火牆阻擋？**
   ```powershell
   # 允許 Python 通過防火牆
   netsh advfirewall firewall add rule name="Agriculture Bot" dir=in action=allow program="C:\agriculture-line-bot\.venv\Scripts\python.exe" enable=yes
   ```

### 問題 6：記憶體不足

**症狀**：系統變慢，應用當機

**解決方法**：
```powershell
# 檢查記憶體使用
Get-Process python | Select-Object Name, WS

# 如果過高，重啟應用
Ctrl + C
.\快速啟動.bat
```

---

## 🎯 進階設定

### 固定 ngrok 網址（付費功能）

1. **升級 ngrok 帳號**
   - https://dashboard.ngrok.com/billing/subscription

2. **設定固定域名**
   ```powershell
   ngrok http 5000 --domain=your-domain.ngrok-free.app
   ```

3. **只需設定一次 LINE Webhook**

### 使用 Cloudflare Tunnel（免費固定網址）

1. **安裝 cloudflared**
   ```powershell
   choco install cloudflared
   ```

2. **登入 Cloudflare**
   ```powershell
   cloudflared tunnel login
   ```

3. **建立 tunnel**
   ```powershell
   cloudflared tunnel create agriculture-bot
   ```

4. **設定並啟動**
   ```powershell
   cloudflared tunnel --url http://localhost:5000
   ```

### 監控與日誌

**啟用詳細日誌**：
```python
# 修改 app.py
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('bot.log'),
        logging.StreamHandler()
    ]
)
```

**查看日誌**：
```powershell
Get-Content bot.log -Tail 50 -Wait
```

---

## 📊 效能優化

### 減少記憶體使用

1. **使用較小的 embedding 模型**（可選）
2. **定期重啟應用**（每週一次）
3. **關閉 DEBUG 模式**（生產環境）

### 提升回應速度

1. **向量資料庫已載入記憶體** ✓
2. **Groq API 已使用最快模型** ✓
3. **優化 TOP_K_RESULTS**（目前 3 個）

---

## 🔐 安全建議

### 本機執行安全性

✅ **優勢**：
- .env 文件不會外洩
- 完全控制存取權限
- 無需擔心雲端服務漏洞

⚠️ **注意**：
- 確保 Windows 防火牆開啟
- 定期更新 Windows 和 Python
- ngrok 提供基本安全性

### 測試端點保護

生產環境建議關閉：
```env
# .env
ENABLE_TEST_ENDPOINT=False
```

或設定強密碼：
```env
ENABLE_TEST_ENDPOINT=True
TEST_API_KEY=your-strong-random-key-here
```

---

## 📞 支援資源

### 常用連結

- **ngrok Dashboard**: https://dashboard.ngrok.com/
- **LINE Developers**: https://developers.line.biz/console/
- **Groq Console**: https://console.groq.com/
- **專案 GitHub**: https://github.com/kawlmlonq/agriculture-line-bot

### 快速命令

```powershell
# 啟動服務
.\快速啟動.bat

# 啟動 ngrok
.\啟動ngrok.bat

# 檢查狀態
.\檢查狀態.bat

# 更新資料庫
.\更新資料庫.bat

# 安全檢查
.\安全檢查.ps1
```

---

## 🎉 完成！

恭喜！您的農業 LINE Bot 現在在本機電腦上運行了！

### 下一步

1. ✅ 發送訊息測試 LINE Bot
2. ✅ 上傳圖片測試圖片分析
3. ✅ 設定開機自動啟動（選用）
4. ✅ 考慮升級 ngrok 取得固定網址

### 需要協助？

遇到問題請參考[故障排除](#故障排除)章節，或查看專案 README.md。

---

**享受您的農業智能助手！** 🌾🤖
