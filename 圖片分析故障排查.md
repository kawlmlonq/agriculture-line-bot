# 🔧 圖片分析功能故障排查指南

## 🐛 常見問題與解決方案

### 問題 1: "抱歉，圖片分析時發生錯誤"

#### 可能原因與解決方法：

#### 1️⃣ **圖片格式問題**
**症狀：** 傳送某些格式的圖片失敗

**解決方案：**
- ✅ 建議使用 **JPG** 或 **PNG** 格式
- ❌ 避免使用 BMP、GIF、TIFF 等格式
- 💡 可以用手機拍照後直接傳送（通常是 JPG）

#### 2️⃣ **圖片太大**
**症狀：** 高解析度照片處理失敗

**解決方案：**
- ✅ 壓縮圖片至 5MB 以下
- ✅ 使用手機的「中等」畫質拍照
- ✅ 系統會自動縮小至 800x800 像素

**檢查方法：**
```batch
# 查看圖片資訊
python -c "from PIL import Image; img = Image.open('your_image.jpg'); print(f'{img.width}x{img.height}, {img.format}')"
```

#### 3️⃣ **圖片下載失敗**
**症狀：** LINE 無法下載圖片內容

**解決方案：**
- ✅ 檢查網路連線
- ✅ 重新傳送圖片
- ✅ 確認 LINE Bot 權限設定正確

#### 4️⃣ **API 限制**
**症狀：** 短時間內傳送多張圖片後失敗

**解決方案：**
- ✅ 等待 1-2 分鐘後再試
- ✅ 避免連續快速傳送多張圖片
- ✅ Groq API 有 rate limit 限制

#### 5️⃣ **模型不支援的內容**
**症狀：** 特定類型的圖片無法分析

**解決方案：**
- ✅ 確保圖片清晰、光線充足
- ✅ 主體物要明顯、不要太遠
- ✅ 避免模糊、過暗、過曝的照片

---

## 🔍 改進內容（最新版本）

### 1. 增強的錯誤處理
```python
✅ 詳細的錯誤日誌
✅ 針對不同錯誤類型的訊息
✅ 完整的 traceback 輸出
```

### 2. 圖片預處理
```python
✅ 自動轉換為 RGB 模式
✅ 移除 RGBA 透明度
✅ 統一輸出 JPEG 格式
✅ 智能縮放（最大 800px）
```

### 3. 更好的使用者回饋
```python
✅ 下載進度提示
✅ 處理中的即時回饋
✅ 具體的錯誤原因說明
```

---

## 🧪 測試方法

### 方法 1：使用測試腳本
```batch
# 測試本地圖片
python test_image_analysis.py test_image.jpg
```

### 方法 2：檢查伺服器日誌
```batch
# 查看 Flask 視窗的輸出
# 會顯示詳細的處理過程：
# - 圖片大小
# - 格式轉換
# - API 呼叫
# - 錯誤訊息
```

### 方法 3：LINE 測試
```
1. 傳送測試圖片到 LINE Bot
2. 觀察回應訊息
3. 如果失敗，查看 Flask 視窗的錯誤
```

---

## 📊 日誌說明

### 正常流程的日誌：
```
收到使用者 Uxxx 的圖片訊息 (ID: 12345)
開始下載圖片 12345
圖片下載完成：245680 bytes，240 chunks
開始分析圖片...
原始圖片: JPEG, 大小: 1920x1080, 模式: RGB
處理後圖片大小: 156234 bytes
Base64 編碼長度: 208312
呼叫 Groq Vision API，模型: meta-llama/llama-4-scout-17b-16e-instruct
API 回應成功，回答長度: 543
分析完成，結果長度: 543
圖片分析完成並回覆使用者
```

### 錯誤流程的日誌：
```
收到使用者 Uxxx 的圖片訊息 (ID: 12345)
開始下載圖片 12345
圖片處理失敗：[錯誤訊息]
[詳細的 traceback]
```

---

## 💡 最佳實踐

### 拍照建議：
1. ✅ **光線充足**：白天自然光最佳
2. ✅ **對焦清晰**：確保主體清楚
3. ✅ **距離適中**：不要太遠或太近
4. ✅ **背景簡單**：避免雜亂背景
5. ✅ **角度適當**：正面或斜上方

### 圖片要求：
- **格式**：JPG 或 PNG
- **大小**：< 5MB
- **解析度**：800-2000 像素（寬或高）
- **內容**：農作物、植物、病蟲害相關

---

## 🛠️ 進階除錯

### 檢查 Groq API 狀態
```python
python -c "from groq import Groq; from config import Config; client = Groq(api_key=Config.GROQ_API_KEY); models = client.models.list(); print('API 連線正常')"
```

### 測試圖片編碼
```python
python -c "from PIL import Image; import base64; img = Image.open('test.jpg'); print(f'格式: {img.format}, 模式: {img.mode}, 大小: {img.size}')"
```

### 查看 Vision 模型
```python
python -c "from groq import Groq; from config import Config; client = Groq(api_key=Config.GROQ_API_KEY); models = [m.id for m in client.models.list().data if 'scout' in m.id]; print(models)"
```

---

## 📞 仍然有問題？

如果以上方法都無法解決：

1. **查看完整日誌**
   - Flask 視窗的完整輸出
   - 包含 traceback 的錯誤訊息

2. **檢查環境**
   - Python 版本
   - 套件版本：`pip list | findstr "groq pillow"`
   - Groq API key 是否有效

3. **測試簡化案例**
   - 使用很小的圖片（< 100KB）
   - 使用標準 JPG 格式
   - 單獨測試不透過 LINE

---

## 🎯 改進效果

**改進前：**
- ❌ 錯誤訊息不明確
- ❌ 大圖片可能失敗
- ❌ 某些格式不支援
- ❌ 沒有詳細日誌

**改進後：**
- ✅ 具體的錯誤原因
- ✅ 自動縮放大圖片
- ✅ 統一轉換格式
- ✅ 完整的處理日誌
- ✅ 更友善的使用者提示

---

**立即測試更新後的功能！** 🚀
